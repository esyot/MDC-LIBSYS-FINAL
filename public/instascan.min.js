!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("babel-polyfill")):"function"==typeof define&&define.amd?define(["exports","babel-polyfill"],t):t(e.Instascan=e.Instascan||{})}(this,function(e){"use strict";class t{constructor(){this._listenerMap={}}addEventListener(e,t){(this._listenerMap[e]||(this._listenerMap[e]=[])).push(t)}removeEventListener(e,t){const n=this._listenerMap[e];if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}dispatchEvent(e){const t=this._listenerMap[e.type];t&&t.slice().forEach(function(t){t(e)})}}class n{static list(){return navigator.mediaDevices.enumerateDevices().then(function(e){return e.filter(function(e){return"videoinput"===e.kind}).map(function(e){return new n(e)})})}constructor(e){this.id=e.deviceId,this.name=e.label||"Camera "+(n._counter++),this._stream=null}start(){const e=this;return n._getConstraints(this.id).then(function(t){return navigator.mediaDevices.getUserMedia(t)}).then(function(t){return e._stream=t,t})}stop(){return Promise.resolve().then(()=>{this._stream&&(this._stream.getTracks().forEach(function(e){e.stop()}),this._stream=null)})}static _getConstraints(e){return Promise.resolve({video:{deviceId:{exact:e}}})}}n._counter=1;class i extends t{constructor(e){if(super(),this._element=e,this._element.tagName.toLowerCase()){if("video"!==this._element.tagName.toLowerCase())throw new Error("Expected <video> element.");this._element.width=640,this._element.height=480,this._element.autoplay=!0,this._element.setAttribute("playsinline","true")}else{this._element.width=640,this._element.height=480,this._element.autoplay=!0,this._element.setAttribute("playsinline","true")}this._active=!1,this._mirror=!1,this._lastImageData=null,this._scanPeriod=1e3/30,this._scanPeriod=100,this._continue=!0}get active(){return this._active}get mirror(){return this._mirror}set mirror(e){this._mirror=Boolean(e),this._element.style.transform=e?"scaleX(-1)":"scaleX(1)"}start(e){const t=this;return t._active?Promise.resolve():Promise.resolve().then(function(){t._active=!0}).then(function(){return e.start()}).then(function(e){t._element.srcObject=e,t._element.play(),t._scanLoop()})}stop(){const e=this;return e._active?Promise.resolve().then(function(){e._active=!1}).then(function(){e._element.pause(),e._element.srcObject&&e._element.srcObject.getTracks().forEach(function(e){e.stop()}),e._element.srcObject=null}):Promise.resolve()}_scanLoop(){const e=this;e._active&&setTimeout(function(){e._continue&&e._scanLoop(),e._active&&e._scan()},e._scanPeriod)}_scan(){const e=this;if(e._element.readyState===e._element.HAVE_ENOUGH_DATA){let t=e._element.width,n=e._element.height;if(!e._canvas){const n=e._element;n.style.display="block";let i=n.offsetHeight,a=n.offsetWidth;t*=a/640,n.height=i}else{e._canvas.width=t,e._canvas.height=n;const i=e._canvas.getContext("2d");i.drawImage(e._element,0,0,t,n),i.fillStyle="rgba(255,255,255,0.5)",i.fillRect(0,0,t,n),i.fillStyle="rgba(0,0,0,0.5)",i.fillRect(0,n/2-1,t,2),i.strokeStyle="rgba(255,0,0,0.5)",i.lineWidth=2,i.strokeRect(0,0,t,n),i.strokeRect(0,n/2-1,t,2)}const i=e._canvas.getContext("2d").getImageData(0,0,t,n);if(e._lastImageData){const t=o.detect(i.data,i.width,i.height,e._lastImageData.data);if(t.length>0){const t=new CustomEvent("scan",{detail:i.data});t.result=i,e.dispatchEvent(t)}}e._lastImageData=i}}}class o{static detect(e,t,n,i){const o=[];for(let l=0;l<t;l++)for(let a=0;a<n;a++){const t=o[y(l,a)]=c(e,y(l,a)),i=5;if(t<200){let t=0,o=0;for(let s=-i;s<=i;s++)for(let e=-i;e<=i;e++)t+=r(l+s,a+e),o+=c(e,y(l+s,a+e));t=o/t;const i={x:l,y:a,intensity:t};o.push(i)}}return o}static _compare(p,l,a,r,c,y,e,o,s){const i=[];for(let t of p)i.push({s1:o.squares[0],s2:o.squares[1],score:Math.abs(t.intensity-r.intensity)});return i.sort((e,t)=>e.score-t.score).slice(0,s)}static _similarity(e,t){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)}static _distance(e,t){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)}static _threshold(e,t){return Math.abs(e-t)<200}static _intensity(e){const t=(e>>16&255)+e>>8&255+e&255;return t/3}static _color(e,t,n,i){const o=(e>>16&255)+e>>8&255+e&255;return Math.abs(o-i)>50?0:1}}function l(e,t,n){const i=n.data,o=[];for(let n=0;n<e;n++)for(let e=0;e<t;e++)i.data[i.index(e,n)]=e*e/t*n;return i}function a(e){const t=e.data,n=e.width,i=e.height,o=[];for(let l=0;l<n;l++)for(let a=0;a<i;a++)o.push(c(t,y(l,a)));return o}function r(e,t){return e>=0&&t>=0}function c(e,t){return e[t]}function y(e,t){return 4*e+4*t*640}e.Scanner=i,e.Camera=n,Object.defineProperty(e,"__esModule",{value:!0})});
